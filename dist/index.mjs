import*as n from"@actions/core";import*as R from"@actions/github";import G from"ali-oss";import{resolve as _,basename as W}from"path";import*as A from"@actions/core";import*as K from"fast-glob";import{existsSync as j,statSync as q}from"fs";var O=class extends Error{constructor(e,r,o,i){super(e),this.name="OSSActionError",r!==void 0&&(this.code=r),o!==void 0&&(this.statusCode=o),i!==void 0&&(this.filePath=i)}},h=class extends O{constructor(e){super(`Validation Error: ${e}`,"VALIDATION_ERROR"),this.name="ValidationError"}},x=class extends O{constructor(e,r){super(`Network Error: ${e}`,"NETWORK_ERROR",r),this.name="NetworkError"}},g=class extends O{constructor(e){super(`File not found: ${e}`,"FILE_NOT_FOUND",void 0,e),this.name="FileNotFoundError"}};import{promises as k}from"fs";import{basename as B}from"path";import*as p from"@actions/core";function I(t){let e=["accessKey","secretKey","bucket","assets"];for(let r of e)if(!t[r])throw new h(`Required input '${r}' is missing`);if(t.timeout){let r=parseInt(t.timeout,10);if(isNaN(r)||r<=0)throw new h("Timeout must be a positive number")}if(t.maxRetries){let r=parseInt(t.maxRetries,10);if(isNaN(r)||r<0)throw new h("Max retries must be a non-negative number")}}function z(t){let e=[];for(let r of t.split(`
`)){let o=r.trim();if(!o)continue;let[i,s]=o.split(":");if(!i||!s){p.warning(`\u26A0\uFE0F  Skipping invalid rule: ${o}`);continue}e.push({source:i.trim(),destination:s.trim(),isDirectory:s.trim().endsWith("/")})}return e}function m(t){let e=["B","KB","MB","GB","TB"],r=t,o=0;for(;r>=1024&&o<e.length-1;)r/=1024,o++;return`${r.toFixed(2)} ${e[o]}`}function b(t){let e=t/1e3;if(e<60)return`${e.toFixed(1)}s`;if(e<3600){let r=Math.floor(e/60),o=e%60;return`${r}m ${o.toFixed(0)}s`}else{let r=Math.floor(e/3600),o=Math.floor(e%3600/60);return`${r}h ${o}m`}}function C(t,e=1e3,r=1e4,o=2){let i=e*Math.pow(o,t);return Math.min(i,r)}async function P(t){try{if(!(await k.stat(t)).isFile())throw new g(`Path is not a file: ${t}`)}catch(e){throw e.code==="ENOENT"?new g(t):e}}async function E(t){return await P(t),{size:(await k.stat(t)).size,name:B(t)}}function v(t){if(!t)return{};try{return JSON.parse(t)}catch{return p.warning(`\u26A0\uFE0F  Failed to parse headers JSON: ${t}`),{}}}function D(t){return t.replace(/^\/+/,"").replace(/\/+/g,"/")}function N(t){return new Promise(e=>setTimeout(e,t))}function T(t,e){let r=e.replace(/\*+.*$/g,"").replace(/\/$/,"");if(t.startsWith(r)){let o=t.substring(r.length);return o.startsWith("/")?o.substring(1):o}return t.split("/").pop()||t}function S(t,e){let r=e?`${t}: ${e}`:t;p.info(`\u{1F527} ${r}`)}function F(t){p.info(`\u2705 ${t}`)}function $(t){p.warning(`\u26A0\uFE0F  ${t}`)}function y(t){p.error(`\u274C ${t}`)}function a(t,e){w()&&(e&&typeof e=="object"?p.info(`\u{1F41B} DEBUG: ${t}: ${JSON.stringify(e,null,2)}`):e!==void 0?p.info(`\u{1F41B} DEBUG: ${t}: ${e}`):p.info(`\u{1F41B} DEBUG: ${t}`))}function w(){if(process.env.ACTIONS_STEP_DEBUG==="true")return!0;try{return p.getInput("enable-debug")==="true"}catch{return!1}}var U=class{constructor(e,r={maxRetries:3,baseDelay:1e3,maxDelay:1e4,backoffMultiplier:2}){this.config=e,this.oss=new G(e),this.retryConfig=r,this.stats={totalFiles:0,uploadedFiles:0,failedFiles:0,totalSize:0,uploadedSize:0,totalDuration:0,successRate:0}}async uploadFiles(e,r={}){let o=[],i=Date.now();S("Starting upload process",`${e.length} rule(s)`),a("Upload process started",{rulesCount:e.length,options:r});for(let s of e)try{a("Processing upload rule",{rule:s,ruleIndex:e.indexOf(s)+1});let u=await this.processRule(s,r);o.push(...u),a("Rule processing completed",{rule:s.source+" \u2192 "+s.destination,resultCount:u.length})}catch(u){y(`Failed to process rule: ${s.source} \u2192 ${s.destination}`),a("Rule processing failed",{rule:s,error:u instanceof Error?u.message:u}),u instanceof Error&&A.error(u.message),this.stats.failedFiles++}return this.stats.totalDuration=Date.now()-i,this.stats.successRate=this.stats.totalFiles>0?this.stats.uploadedFiles/this.stats.totalFiles*100:0,this.logFinalStats(),o}async processRule(e,r){S("Processing rule",`${e.source} \u2192 ${e.destination}`),a("Processing upload rule",e);let o=e.source;e.isDirectory&&!o.includes("*")&&!o.includes("?")&&!o.includes("[")&&(j(o)&&q(o).isFile()||(o=o.endsWith("/")?`${o}**/*`:`${o}/**/*`,S("Converted directory pattern",`${e.source} \u2192 ${o}`))),a("Searching for files with pattern",o);let i=K.sync([o],{dot:!1,onlyFiles:!0,absolute:!0});a("Found files",{pattern:o,count:i.length,files:i});let s=!o.includes("*")&&!o.includes("?")&&!o.includes("[");if(i.length===0)return s?(y(`File not found: ${e.source}`),this.stats.totalFiles+=1,this.stats.failedFiles+=1,[]):($(`No files found matching pattern: ${o}`),[]);this.stats.totalFiles+=i.length,S(`Found ${i.length} file(s) to upload`);let u=[];if(e.isDirectory)for(let c of i){let l;if(i.length===1&&!e.source.includes("*")&&!e.source.includes("?")&&!e.source.includes("[")){let f=W(c);l=D(`${e.destination}${f}`)}else{let f=T(c,e.source);l=D(`${e.destination}${f}`)}let d=await this.uploadSingleFile(c,l,r);d&&u.push(d)}else{i.length>1&&$(`Multiple files found but destination is single file. Using first file: ${i[0]}`);let c=await this.uploadSingleFile(i[0],e.destination,r);c&&u.push(c)}return u}async uploadSingleFile(e,r,o){try{a("Starting single file upload",{localPath:e,remotePath:r});let i=await E(e);this.stats.totalSize+=i.size,a("File stats obtained",{localPath:e,size:i.size,name:i.name});let s=await this.uploadWithRetry(()=>this.performUpload(e,r,o),e,i);return s&&(this.stats.uploadedFiles++,this.stats.uploadedSize+=i.size),s}catch(i){if(this.stats.failedFiles++,y(`Failed to upload ${e}: ${i instanceof Error?i.message:"Unknown error"}`),i instanceof g)throw i;return null}}async performUpload(e,r,o){a("Performing OSS upload",{localPath:e,remotePath:r,options:o});let i={timeout:o.timeout||6e5,...o};o.gzip&&(i.headers={...i.headers||{},"Content-Encoding":"gzip"});let s=await this.oss.put(r,_(e),i);a("OSS upload response received",{remotePath:r,responseStatus:s?.res?.status});let u=s,c=await E(e),l={success:!0,filePath:e,objectKey:r,size:c.size,...u.res?.headers?.etag&&{etag:u.res.headers.etag},...u.url&&{url:u.url}};return a("Upload result created",l),l}async uploadWithRetry(e,r,o){let i=m(o.size);a("Starting upload with retry",{fileName:o.name,size:i,maxRetries:this.retryConfig.maxRetries});for(let s=0;s<this.retryConfig.maxRetries;s++)try{let u=s>0?` - Retry ${s}`:"";S(`\u2B06\uFE0F  Uploading ${o.name} (${i})${u}`),a("Upload attempt",{attempt:s+1,fileName:o.name});let c=Date.now(),l=await e(),d=Date.now()-c;return F(`Uploaded ${o.name} in ${b(d)}`),a("Upload successful",{fileName:o.name,duration:d,attempt:s+1}),l}catch(u){let c=s===this.retryConfig.maxRetries-1,l=u instanceof Error?u.message:"Unknown error";$(`Upload failed for ${o.name}: ${l}`),a("Upload attempt failed",{fileName:o.name,attempt:s+1,error:l,isLastAttempt:c});let d=u instanceof Error?u:new Error(String(u));if(!this.isRetryableError(d)||c)throw c&&y(`\u{1F4A5} All ${this.retryConfig.maxRetries} attempts failed for ${o.name}`),d;let f=C(s,this.retryConfig.baseDelay,this.retryConfig.maxDelay,this.retryConfig.backoffMultiplier);S(`\u23F3 Retrying in ${b(f)}... (attempt ${s+2}/${this.retryConfig.maxRetries})`),a("Retry delay calculated",{delayMs:f,attempt:s,fileName:o.name}),await N(f)}return null}isRetryableError(e){if(e instanceof g)return!1;if(e instanceof x)return!0;let r=e;return r.code?["RequestTimeout","ServiceUnavailable","Throttling","InternalError","ConnectionTimeout","SocketTimeout"].includes(r.code):r.status?[408,429,500,502,503,504].includes(r.status):(e.message&&e.message.toLowerCase().includes("timeout"),!0)}getStats(){return{...this.stats}}logFinalStats(){let e=b(this.stats.totalDuration),r=m(this.stats.totalSize),o=m(this.stats.uploadedSize);F(`Upload completed! ${this.stats.uploadedFiles}/${this.stats.totalFiles} files (${o}/${r}) uploaded in ${e}`),this.stats.failedFiles>0&&$(`${this.stats.failedFiles} file(s) failed to upload`)}async testConnection(){try{return a("Testing OSS connection",{bucket:this.config.bucket,region:this.config.region}),await this.oss.getBucketInfo(this.config.bucket),F("OSS connection test successful"),a("OSS connection test details",{bucket:this.config.bucket,status:"success"}),!0}catch(e){let r=e instanceof Error?e.message:"Unknown error";return y(`OSS connection test failed: ${r}`),a("OSS connection test failed",{bucket:this.config.bucket,error:r}),!1}}};async function L(){let t=Date.now();try{n.info("\u{1F680} Starting OSS upload process..."),w()&&(n.info("\u{1F41B} ==============================================="),n.info("\u{1F41B} DEBUG MODE ENABLED - Verbose logging active"),n.info("\u{1F41B} ==============================================="),a("Debug mode enabled",{ACTIONS_STEP_DEBUG:process.env.ACTIONS_STEP_DEBUG,enableDebugInput:n.getInput("enable-debug")}));let e=H();w()&&a("Raw action inputs received",{region:e.region,bucket:e.bucket,timeout:e.timeout,maxRetries:e.maxRetries,enableDebug:e.enableDebug,assetsLength:e.assets.length}),I(e);let r=J(e);a("OSS configuration created",{bucket:r.bucket,region:r.region,endpoint:r.endpoint,timeout:r.timeout}),X(r);let o=V(e);a("Retry configuration",o);let i=Q(e);a("Upload options",i);let s=new U(r,o);await s.testConnection()||n.warning("\u26A0\uFE0F  OSS connection test failed, but continuing with upload...");let c=z(e.assets);if(a("Parsed upload rules",c),c.length===0){n.setFailed("No valid upload rules found in assets input");return}n.info(`\u{1F4CB} Processing ${c.length} upload rule(s)`);let l=await s.uploadFiles(c,i),d=s.getStats();if(a("Upload results",{results:l,stats:d}),await Y(l,d,r),await Z(d,r,t),!(e.continueOnError==="true")&&d.failedFiles>0){n.setFailed(`Upload incomplete: ${d.failedFiles} file(s) failed to upload`);return}let M=b(Date.now()-t);n.info(`\u{1F389} Action completed successfully in ${M}`)}catch(e){let r=e instanceof Error?e.message:"Unknown error occurred";n.error(`\u{1F4A5} Action failed: ${r}`),n.setFailed(r)}}function H(){return{accessKey:n.getInput("access-key",{required:!0}),secretKey:n.getInput("secret-key",{required:!0}),bucket:n.getInput("bucket",{required:!0}),assets:n.getInput("assets",{required:!0}),region:n.getInput("region")||void 0,endpoint:n.getInput("endpoint")||void 0,timeout:n.getInput("timeout")||"120",maxRetries:n.getInput("max-retries")||"3",continueOnError:n.getInput("continue-on-error")||"false",enableGzip:n.getInput("enable-gzip")||"false",publicRead:n.getInput("public-read")||"false",headers:n.getInput("headers")||void 0,enableDebug:n.getInput("enable-debug")||"false"}}function J(t){let e={accessKeyId:t.accessKey,accessKeySecret:t.secretKey,bucket:t.bucket,timeout:parseInt(t.timeout||"600",10)*1e3};return t.region&&(e.region=t.region),t.endpoint&&(e.endpoint=t.endpoint),e}function V(t){return{maxRetries:parseInt(t.maxRetries||"3",10),baseDelay:1e3,maxDelay:1e4,backoffMultiplier:2}}function Q(t){let e={timeout:parseInt(t.timeout||"600",10)*1e3},r=v(t.headers);return Object.keys(r).length>0&&(e.headers=r),t.enableGzip==="true"&&(e.gzip=!0),t.publicRead==="true"&&(e["x-oss-object-acl"]="public-read"),e}function X(t){n.info(`\u{1F4E6} Connecting to OSS bucket: ${t.bucket}`),t.region&&n.info(`\u{1F30D} Region: ${t.region}`),t.endpoint&&n.info(`\u{1F517} Endpoint: ${t.endpoint}`),n.info(`\u23F1\uFE0F Timeout: ${t.timeout/1e3}s`)}async function Y(t,e,r){t.length>0?(n.setOutput("url",t.map(o=>o.url).join(",")),n.setOutput("urls",JSON.stringify(t.map(o=>o.url)))):(n.setOutput("url",""),n.setOutput("urls",JSON.stringify([]))),n.setOutput("count",e.uploadedFiles.toString()),n.setOutput("total-files",e.totalFiles.toString()),n.setOutput("uploaded-files",e.uploadedFiles.toString()),n.setOutput("failed-files",e.failedFiles.toString()),n.setOutput("total-size",e.totalSize.toString()),n.setOutput("uploaded-size",e.uploadedSize.toString()),n.setOutput("success-rate",e.successRate.toFixed(1)),n.setOutput("duration",e.totalDuration.toString()),n.setOutput("bucket",r.bucket),n.setOutput("region",r.region||"default")}async function Z(t,e,r){let o=b(Date.now()-r),i=m(t.totalSize),s=m(t.uploadedSize);await n.summary.addHeading("OSS Upload Summary \u{1F4E6}").addTable([[{data:"Metric",header:!0},{data:"Value",header:!0}],["Total Files Found",t.totalFiles.toString()],["Files Uploaded",t.uploadedFiles.toString()],["Files Failed",t.failedFiles.toString()],["Success Rate",`${t.successRate.toFixed(1)}%`],["Total Size",i],["Uploaded Size",s],["Total Time",o],["Bucket",e.bucket],["Region",e.region||"default"]]).addDetails("GitHub Action Context",[`**Repository**: ${R.context.repo.owner}/${R.context.repo.repo}`,`**Workflow**: ${R.context.workflow}`,`**Run ID**: ${R.context.runId}`,`**SHA**: ${R.context.sha.substring(0,7)}`].join(`
`)).write()}import.meta.url===`file://${process.argv[1]}`&&L().catch(t=>{n.setFailed(t instanceof Error?t.message:"Unknown error"),process.exit(1)});export{L as run};
//# sourceMappingURL=index.mjs.map